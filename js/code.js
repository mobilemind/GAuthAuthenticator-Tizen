// A simple authentication application written in HTML
// Copyright (C) 2012 Gerard Braad
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
var StorageService=function(){var setObject=function(key,value){localStorage.setItem(key,JSON.stringify(value))},getObject=function(key){var value=localStorage.getItem(key);return value&&JSON.parse(value)},isSupported=function(){return typeof Storage!="undefined"};return{isSupported:isSupported,getObject:getObject,setObject:setObject}},KeyUtilities=function(){var dec2hex=function(s){return(s<15.5?"0":"")+Math.round(s).toString(16)},hex2dec=function(s){return parseInt(s,16)},base32tohex=function(base32){var base32chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bits="",hex="";for(var i=0;i<base32.length;i++){var val=base32chars.indexOf(base32.charAt(i).toUpperCase());bits+=leftpad(val.toString(2),5,"0")}for(var i=0;i+4<=bits.length;i+=4){var chunk=bits.substr(i,4);hex+=parseInt(chunk,2).toString(16)}return hex},leftpad=function(str,len,pad){return len+1>=str.length&&(str=Array(len+1-str.length).join(pad)+str),str},generate=function(secret){var key=base32tohex(secret),epoch=Math.round((new Date).getTime()/1e3),time=leftpad(dec2hex(Math.floor(epoch/30)),16,"0"),hmacObj=new jsSHA(time,"HEX"),hmac=hmacObj.getHMAC(key,"HEX","SHA-1","HEX");if(hmac!="KEY MUST BE IN BYTE INCREMENTS")var offset=hex2dec(hmac.substring(hmac.length-1));var otp=(hex2dec(hmac.substr(offset*2,8))&hex2dec("7fffffff"))+"";return otp.substr(otp.length-6,6).toString()};return{generate:generate}},KeysController=function(){var storageService,keyUtilities,init=function(){storageService=new StorageService,keyUtilities=new KeyUtilities,storageService.isSupported()?(storageService.getObject("accounts")||addAccount("alice@google.com","JBSWY3DPEHPK3PXP"),updateKeys(),setInterval(timerTick,1e3)):($("#updatingIn").text("x"),$("#accountsHeader").text("No Storage support")),$("#add").click(function(){var name=$("#keyAccount").val(),secret=$("#keySecret").val();secret=secret.replace(/ /g,""),secret!=""&&addAccount(name,secret)})},timerTick=function(){var epoch=Math.round((new Date).getTime()/1e3),countDown=30-epoch%30;epoch%30==0&&updateKeys(),$("#updatingIn").text(countDown)},updateKeys=function(){var accountList=$("#accounts");accountList.find("li:gt(0)").remove(),$.each(storageService.getObject("accounts"),function(index,account){var key=keyUtilities.generate(account.secret),delLink=$('<a href="#"></a>');delLink.click(function(){deleteAccount(index)});var detLink=$('<a href="#"><h3>'+key+"</h3><p>"+account.name+"</p></a>"),accElem=$("<li>").append(detLink).append(delLink);accountList.append(accElem)}),accountList.listview("refresh")},deleteAccount=function(index){var accounts=storageService.getObject("accounts");accounts.splice(index,1),storageService.setObject("accounts",accounts),updateKeys()},addAccount=function(name,secret){if(secret=="")return!1;var account={name:name,secret:secret},accounts=storageService.getObject("accounts");return accounts||(accounts=[]),accounts.push(account),storageService.setObject("accounts",accounts),$("#keyAccount").val(""),$("#keySecret").val(""),updateKeys(),!0};return{init:init,addAccount:addAccount,deleteAccount:deleteAccount}};$(document).bind("pagecreate",function(){$('div[data-role="dialog"]').live("pagebeforeshow",function(e,ui){ui.prevPage.addClass("ui-dialog-background")}),$('div[data-role="dialog"]').live("pagehide",function(e,ui){$(".ui-dialog-background ").removeClass("ui-dialog-background")});var keysController=new KeysController;keysController.init()});